#!/usr/bin/env perl
use strict;
use warnings;

use MIDI::Simple;
use Math::Combinatorics;
use List::MoreUtils qw( pairwise );

my $phrases = 1;

my @treb_notes = qw( C5 D5 E5 A5 );
my @bass_notes = qw( C3 F3 G3 C3 );

my @treb_combos = permute(@treb_notes);
my @bass_combos = permute(@bass_notes);

my $score = setup_midi( scalar(@treb_notes), 'qn', 5, 9, 38, 1, 0, 120 );

for ( 1 .. $phrases ) {
    for my $t ( 0 .. @treb_combos - 1 ) {
        my @pairs = pairwise { [ $a, $b ] } @{ $treb_combos[$t] }, @{ $bass_combos[$t] };
        for my $pair ( @pairs ) {
            $score->n(
                { $score->Cookies }->{unit},
                $pair->[0],
                $pair->[1]
            );
        }
    }
}

$score->write_score($0.'.mid');

sub setup_midi {
    my ( $sig, $unit, $octave, $kit, $pad, $instrument, $patch, $volume ) = @_;
    my $score = MIDI::Simple->new_score();
    $score->Volume($volume);
    # Lead-in
    $score->Channel($kit);
    $score->n( $unit, $pad ) for 1 .. $sig;
    # Passage
    $score->Channel($instrument);
    $score->patch_change($instrument, $patch );
    $score->Cookies( unit => $unit );
    return $score;
}
